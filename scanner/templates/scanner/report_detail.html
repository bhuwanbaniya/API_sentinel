{% extends 'scanner/base.html' %}
{% load static %}

{% block title %}Report Detail - API Sentinel{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="header">
    <h1>Scan Analysis</h1>
    <div>
        <a href="{% url 'download_pdf' report.id %}" style="background: #28a745; color: white; padding: 10px 20px; border-radius: 4px; text-decoration: none; font-weight: bold; margin-right: 10px;">
            Download PDF Report
        </a>
        <a href="{% url 'scan_history' %}" style="color: var(--primary-accent); text-decoration: none;">&larr; Back to History</a>
    </div>
</div>

<div class="card" style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h3 style="margin: 0;">Target: {{ report.target_url }}</h3>
        <p style="margin: 5px 0 0 0; color: var(--text-secondary);">Executed on: {{ report.scan_date }}</p>
    </div>
    <div class="risk-badge risk-high" style="font-size: 1.2rem; padding: 10px 20px;">
        STATUS: {{ report.status|upper }}
    </div>
</div>

<div class="dashboard-grid">
    <div class="findings-card">
        <h2>Vulnerabilities ({{ vulnerabilities|length }})</h2>
        <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
            {% for vuln in vulnerabilities %}
                <div class="vuln" style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-left: 4px solid 
                    {% if vuln.severity == 'High' %}#f85149{% elif vuln.severity == 'Medium' %}#f0ad4e{% else %}#58a6ff{% endif %}; 
                    margin-bottom: 20px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <span class="badge badge-{{ vuln.severity }}">{{ vuln.severity }}</span>
                            <strong style="margin-left: 10px; font-size: 1.1rem;">{{ vuln.name }}</strong>
                        </div>
                    </div>
                    
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">{{ vuln.description }}</p>

                    <!-- --- MULTI-LANGUAGE REMEDIATION --- -->
                    {% if vuln.advice %}
                    <div style="margin-top: 15px;">
                        <p style="color: #c9d1d9; margin-bottom: 10px;"><strong>ðŸ’¡ Fix:</strong> {{ vuln.advice }}</p>
                        
                        {% if vuln.snippets %}
                        <div class="tab-container" id="tabs-{{ forloop.counter }}">
                            <div class="tab-header">
                                {% for lang, code in vuln.snippets.items %}
                                <button class="tab-btn {% if forloop.first %}active{% endif %}" 
                                        onclick="openTab(event, '{{ forloop.parentloop.counter }}-{{ forloop.counter }}')">
                                    {{ lang }}
                                </button>
                                {% endfor %}
                            </div>

                            {% for lang, code in vuln.snippets.items %}
                            <div id="{{ forloop.parentloop.counter }}-{{ forloop.counter }}-{{ forloop.index }}" 
                                 class="tab-content {% if forloop.first %}active{% endif %}"
                                 data-group="tabs-{{ forloop.parentloop.counter }}">
                                <pre style="color: #28a745; margin: 0; font-family: 'Consolas', monospace; font-size: 0.85rem; overflow-x: auto;">{{ code }}</pre>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    <!-- ---------------------------------- -->

                </div>
            {% endfor %}
        </div>
    </div>

    <div class="chart-card">
        <h2>Severity Distribution</h2>
        <div class="chart-container" style="height: 250px; position: relative;">
            <canvas id="detailChart"></canvas>
        </div>
    </div>
</div>

<!-- STYLES FOR TABS -->
<style>
.tab-container { margin-top: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; overflow: hidden; }
.tab-header { display: flex; background: #161b22; border-bottom: 1px solid #30363d; overflow-x: auto; }
.tab-btn { background: none; border: none; color: #8b949e; padding: 10px 15px; cursor: pointer; font-family: inherit; font-size: 0.85rem; font-weight: bold; }
.tab-btn:hover { color: #c9d1d9; }
.tab-btn.active { color: #58a6ff; border-bottom: 2px solid #58a6ff; background: rgba(56, 139, 253, 0.1); }
.tab-content { display: none; padding: 15px; background: #000; }
.tab-content.active { display: block; }
</style>

<!-- JAVASCRIPT FOR TABS & CHART -->
{{ chart_data|json_script:"chart-data-json" }}

<script>
    // Tab Switching Logic
    function openTab(evt, tabId) {
        // Find the container
        var container = evt.currentTarget.closest('.tab-container');
        
        // Hide all content divs in this container
        var contents = container.querySelectorAll('.tab-content');
        contents.forEach(div => div.classList.remove('active'));

        // Deactivate all buttons in this container
        var buttons = container.querySelectorAll('.tab-btn');
        buttons.forEach(btn => btn.classList.remove('active'));

        // Activate clicked button and find matching content
        evt.currentTarget.classList.add('active');
        
        // Find the content div by index (hacky but works for simple loop)
        // Better: Use direct traversal
        // Since we are generating unique IDs, we need to match them carefully.
        // Let's use simpler index-based matching for robustness in Django loops.
        var index = Array.from(buttons).indexOf(evt.currentTarget);
        contents[index].classList.add('active');
    }

    // Chart Logic
    document.addEventListener('DOMContentLoaded', function() {
        const dataBox = document.getElementById('chart-data-json');
        if (dataBox) {
            const chartData = JSON.parse(dataBox.textContent);
            if (chartData.data && chartData.data.length > 0) {
                const ctx = document.getElementById('detailChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.data,
                            backgroundColor: chartData.colors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: { legend: { position: 'bottom', labels: { color: '#c9d1d9' } } }
                    }
                });
            }
        }
    });
</script>
{% endblock %}