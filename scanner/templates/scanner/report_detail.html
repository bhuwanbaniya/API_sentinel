{% extends 'scanner/base.html' %}
{% load static %}

{% block title %}Report Detail - API Sentinel{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="header">
    <h1>Scan Analysis</h1>
    <a href="{% url 'scan_history' %}" style="color: var(--primary-accent); text-decoration: none;">&larr; Back to History</a>
</div>

<div class="card" style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h3 style="margin: 0;">Target: {{ report.target_url }}</h3>
        <p style="margin: 5px 0 0 0; color: var(--text-secondary);">Executed on: {{ report.scan_date }}</p>
    </div>
    <div class="risk-badge risk-high" style="font-size: 1.2rem; padding: 10px 20px;">
        STATUS: {{ report.status|upper }}
    </div>
</div>
<div class="header">
    <h1>Scan Analysis</h1>
    <div>
        <a href="{% url 'download_pdf' report.id %}" style="background: #28a745; color: white; padding: 10px 20px; border-radius: 4px; text-decoration: none; font-weight: bold; margin-right: 10px;">
            Download PDF Report
        </a>
        <a href="{% url 'scan_history' %}" style="color: var(--primary-accent); text-decoration: none;">&larr; Back to History</a>
    </div>
</div>
<div class="dashboard-grid">
    <!-- Findings -->
    <div class="findings-card">
        <h2>Vulnerabilities ({{ vulnerabilities|length }})</h2>
        <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
            {% for vuln in vulnerabilities %}
                <div class="vuln" style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-left: 4px solid 
                    {% if vuln.severity == 'High' %}#f85149{% elif vuln.severity == 'Medium' %}#f0ad4e{% else %}#58a6ff{% endif %}; 
                    margin-bottom: 20px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <span class="badge badge-{{ vuln.severity }}">{{ vuln.severity }}</span>
                            <strong style="margin-left: 10px; font-size: 1.1rem;">{{ vuln.name }}</strong>
                        </div>
                    </div>
                    
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">{{ vuln.description }}</p>

                    <!-- --- NEW REMEDIATION BOX --- -->
                    {% if vuln.advice %}
                    <div style="background: #0d1117; border: 1px solid #30363d; border-radius: 6px; overflow: hidden; margin-top: 15px;">
                        <div style="background: #161b22; padding: 8px 15px; border-bottom: 1px solid #30363d; font-size: 0.85rem; font-weight: bold; color: #58a6ff; display: flex; align-items: center;">
                            <span style="margin-right: 8px;">ðŸ’¡</span> Remediation Guide
                        </div>
                        <div style="padding: 15px;">
                            <p style="color: #c9d1d9; font-size: 0.9rem; margin-top: 0; margin-bottom: 10px;">{{ vuln.advice }}</p>
                            {% if vuln.code %}
                            <pre style="background: #000; color: #28a745; padding: 15px; border-radius: 4px; overflow-x: auto; font-family: 'Consolas', 'Courier New', monospace; font-size: 0.85rem; margin: 0; border: 1px solid #333;">{{ vuln.code }}</pre>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    <!-- ----------------------------- -->

                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Chart -->
    <div class="chart-card">
        <h2>Severity Distribution</h2>
        <div class="chart-container" style="height: 250px; position: relative;">
            <canvas id="detailChart"></canvas>
        </div>
    </div>
</div>

<!-- DATA FOR JS -->
{{ chart_data|json_script:"chart-data-json" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dataBox = document.getElementById('chart-data-json');
        if (dataBox) {
            const chartData = JSON.parse(dataBox.textContent);
            console.log("Chart Data Received:", chartData); // Check your browser console!

            if (chartData.data && chartData.data.length > 0) {
                const ctx = document.getElementById('detailChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.data,
                            backgroundColor: chartData.colors,
                            hoverOffset: 10,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { color: '#c9d1d9', font: { size: 12 } } 
                            }
                        }
                    }
                });
            } else {
                document.querySelector('.chart-container').innerHTML = "<p style='text-align:center; color:#8b949e; margin-top:100px;'>No severity data available.</p>";
            }
        }
    });
</script>
{% endblock %}