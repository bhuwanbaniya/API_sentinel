{% extends 'scanner/base.html' %}

{% block title %}Scan History - API Sentinel{% endblock %}

{% block content %}
<div class="header">
    <h1>Scan History</h1>
</div>

<div class="card">
    <table class="history-table">
        <thead>
            <tr>
                <th>Target</th>
                <th>Status</th>
                <th>Date</th>
                <th>Vulns</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for report in all_reports %}
            <!-- SMART ROW LINKING -->
            <tr style="cursor: pointer;" 
                onclick="window.location='{% if report.status == 'Running' %}{% url 'scan_progress' report.id %}{% else %}{% url 'report_detail' report.id %}{% endif %}';">
                
                <td>{{ report.target_url|truncatechars:50 }}</td>
                <td>
                    {% if report.status == "Success" %}
                        <span style="color: #28a745; font-weight: bold;">Success</span>
                    {% elif report.status == "Running" %}
                        <span style="color: #58a6ff; font-weight: bold; animation: pulse 1.5s infinite;">Running...</span>
                    {% elif report.status == "Stopped" %}
                        <span style="color: #f0ad4e; font-weight: bold;">Stopped</span>
                    {% else %}
                        <span style="color: #dc3545; font-weight: bold;">{{ report.status }}</span>
                    {% endif %}
                </td>
                <td>{{ report.scan_date|date:"M d, H:i" }}</td>
                <td>{{ report.result_json.vulnerabilities|length|default:0 }}</td>
                
                <td onclick="event.stopPropagation();">
                    <form method="post" action="{% url 'delete_report' report.id %}" onsubmit="return confirm('Delete this report?');" style="margin:0;">
                        {% csrf_token %}
                        <button type="submit" class="delete-button">&times;</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="5" style="text-align: center; padding: 1rem;">No scan history found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    .delete-button { background: transparent; border: none; color: #e74c3c; font-size: 1.2rem; cursor: pointer; }
    .delete-button:hover { color: #c0392b; }
</style>
{% endblock %}